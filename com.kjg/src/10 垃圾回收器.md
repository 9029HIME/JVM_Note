# 垃圾回收器的分类与性能指标

## 回收器分类

垃圾回收器可以从多个维度进行分类，按工作模式分，可以分成串行垃圾回收器、并行垃圾回收器、并发垃圾回收器

![image](https://user-images.githubusercontent.com/48977889/160401272-d67d0f53-f09e-4d63-b842-67b95fc85bf3.png)

串行垃圾回收器：只有一个线程负责GC，STW时停止所有用户线程（已过时）。

![image](https://user-images.githubusercontent.com/48977889/160401306-8638ceee-cb63-472b-a753-a19dd3024be9.png)

并行垃圾回收器：可以有多个线程**同时负责GC**，但是STW的时候还是要停止所有用户线程。

![image](https://user-images.githubusercontent.com/48977889/160401357-01b5bb79-f549-4429-ad96-9478280a6797.png)

并发垃圾回收器：执行垃圾回收器的线程可以和用户线程交替执行（GC回收的区域和用户线程的使用区域没有交集）。

如果按照内存碎片处理方式区分，又可以分成压缩式垃圾回收器和非压缩式垃圾回收器。两者的区别不言而喻。

如果按照工作的内存区间分，又可分为年轻代垃圾回收器和老年代垃圾回收器。

## 性能指标

衡量一个回收器的算法性能如何，主要通过**吞吐量**和**STW暂停时间**来判断。

吞吐量指的是：运行用户代码时间 /（运行用户代码时间+垃圾收集时间），即分母是总运行时间。

STW暂停时间指的是垃圾回收器在GC阶段，STW导致用户线程暂停的时间。

然而实际上，高吞吐量和低暂停时间是矛盾的，两者不可得兼，具体如下：

![a8cd485474bfb15bdd87db0d1ae0d2d](https://user-images.githubusercontent.com/48977889/160402750-c335c520-1250-4501-a419-198a5826a1ac.jpg)

如果同一时间内，对同样数量的垃圾进行回收，采用高吞吐量的做法是：减少GC次数，增加单次GC所需耗时，这样总的GC耗时相对较少，整体上看系统的吞吐量就高。如果采用低暂停时间的做法，必然会导致GC次数增加，**因为GC这个行为本身就会消耗性能，所以不会因为减少了时间，增加了次数后，暂停时间的总时和高吞吐量做法一样**，即总的时间上看，低暂停时间的做法会导致吞吐率下降。但是低暂停时间能够提高响应速度与用户体验，**特别是对于一个交互式应用程序（就是和用户交互比较多的场景）。**

## 垃圾回收器的介绍

首先回顾垃圾回收器的发展史：

1. 1999年随JDK1.3.1一起来的是串行方式的Serial GC，它是第一款GC。ParNew垃圾收集器是Serial收集器的多线程版本
2. 2002年2月26日，Parallel GC和Concurrent Mark Sweep GC跟随JDK1.4.2一起发布·
3. Parallel GC在JDK6之后成为HotSpot默认GC。
4. 2012年，在JDK1.7u4版本中，G1可用。
5. 2017年，JDK9中G1变成默认的垃圾收集器。
6. 2018年3月，JDK10中G1垃圾回收器的并行完整垃圾回收，实现并行性来改善最坏情况下的延迟。
7. 2018年9月，JDK11发布。引入Epsilon 垃圾回收器，又被称为 "No-Op(无操作)“ 回收器。同时，引入ZGC：可伸缩的低延迟垃圾回收器（Experimental）
8. 2019年3月，JDK12发布。增强G1，自动返回未用堆内存给操作系统。同时，引入Shenandoah GC：低停顿时间的GC（Experimental）。
9. 2019年9月，JDK13发布。增强ZGC，自动返回未用堆内存给操作系统。
10. 2020年3月，JDK14发布。删除CMS垃圾回收器。扩展ZGC在macOS和Windows上的应用

总的来说

有Serial GC（串行）、CMS（并发）、Parallel Scavenge（并行新生代）、Parallel Old（并行老年代）、G1（并发）、Epsilon、ZGC

JDK8：默认使用Parallel Scavenge 和 Parallel Old 两款垃圾回收器的结合。

JDK9：默认使用G1垃圾回收器。

JDK10：对G1进行优化

JDK12：增强G1

JDK13：增强ZGC

JDK14：拓展了ZGC

**目前2022年大部分都在用JDK8，也就是说中期范围内更多是使用Parallel Scavenge+Parallel Old，将来会考虑G1，在长期角度考虑会使用ZGC。**

垃圾回收器之间的分区使用范围和搭配使用策略是：

![image](https://user-images.githubusercontent.com/48977889/160406294-890e931c-f4b0-4518-a525-d8abdc9cbc6f.png![737df7a1109837197a492ab56182ccf](https://user-images.githubusercontent.com/48977889/160406541-74ed6996-999b-48b7-b03f-fad486efba3d.jpg)