# JVM与内存

JVM有自己的一套内存管理机制，该机制规定了Java进程运行过程中对内存的申请、分配、管理的策略，但是不同的JVM的内存管理机制有一定的差异。**其中运行时数据区可以理解为JVM所管理的主要内存区域**。对于运行时数据区的划分，可以参考下图：

![image](https://user-images.githubusercontent.com/48977889/150280032-3a1ce1cf-a056-494b-8598-8a9ab81f58f4.png)

其中代码缓存+元数据区可以理解为方法区。需要注意的是，一个JVM只会有一个运行时数据区，**JVM本身会维护运行时数据区的一个映射对象：即java.lang.Runtime对象**。

对于运行时数据区来说，可以划分为：线程私有区域、线程共享区域。

线程私有区域包括：PC、本地方法栈、虚拟机栈。

线程共享区域包括：方法区、堆。

也就是说：方法区、堆里的数据需要考虑线程安全问题，**注意！不一定是所有堆的数据都会有安全问题，毕竟虚拟机栈的一些指针可能指向堆里，但只有栈所属的线程能访问**。

# Java线程

在HotSpot虚拟机里，一个Java线程会映射为一个lwp线程，这个lwp线程会随着Java线程的创建而创建、终止而回收，这里就体现了线程池的重要性。当lwp线程初始化成功后就调用Java线程的run方法。

在JVM中除了程序线程外，还有其他的Java线程，这些线程维护着进程的运行，包括：虚拟机线程、周期任务线程、GC线程、编译线程、信号调度线程。这也是为什么用jconsole查看java进程时会发现还有其他多个线程。

# PC寄存器

这里的PC寄存器和OS的PC寄存器不是同一个东西，**可以理解为是模仿OS的，一个JVM层面的PC，在OS层面这个PC是一块内存空间**，作用是记录PC持有者（线程）下一条要执行的字节码指令的**地址**。

# 虚拟机栈

虚拟机栈没有GC，但会有OOM。